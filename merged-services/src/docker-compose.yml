version: "3.8"

services:
  # Reverse Proxy
  caddy:
    image: caddy:2.7-alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - ${DATA_ROOT}/caddy/data:/data
      - ${DATA_ROOT}/caddy/config:/config
    depends_on:
      - codimd
      - n8n
    networks:
      - web

  # CodiMD Services
  codimd-db:
    image: postgres:11.6-alpine
    restart: always
    environment:
      - POSTGRES_USER=${CODIMD_DB_USER}
      - POSTGRES_PASSWORD=${CODIMD_DB_PASSWORD}
      - POSTGRES_DB=${CODIMD_DB_NAME}
    volumes:
      - ${DATA_ROOT}/codimd/db:/var/lib/postgresql/data
    networks:
      - backend

  codimd:
    image: hackmdio/hackmd:2.6.1
    restart: always
    environment:
      - CMD_DB_URL=postgres://${CODIMD_DB_USER}:${CODIMD_DB_PASSWORD}@codimd-db/${CODIMD_DB_NAME}
      - CMD_USECDN=false
      - CMD_DOMAIN=${CODIMD_DOMAIN}
      - CMD_PROTOCOL_USESSL=true
      - CMD_ALLOW_ANONYMOUS=false
      - CMD_EMAIL=false
      - CMD_ALLOW_EMAIL_REGISTER=false
      # OAuth2 - Entra ID
      - CMD_OAUTH2_PROVIDERNAME=${CODIMD_OAUTH2_PROVIDERNAME}
      - CMD_OAUTH2_SCOPE=${CODIMD_OAUTH2_SCOPE}
      - CMD_OAUTH2_CLIENT_ID=${CODIMD_OAUTH2_CLIENT_ID}
      - CMD_OAUTH2_CLIENT_SECRET=${CODIMD_OAUTH2_CLIENT_SECRET}
      - CMD_OAUTH2_AUTHORIZATION_URL=${CODIMD_OAUTH2_AUTHORIZATION_URL}
      - CMD_OAUTH2_TOKEN_URL=${CODIMD_OAUTH2_TOKEN_URL}
      - CMD_OAUTH2_USER_PROFILE_URL=${CODIMD_OAUTH2_USER_PROFILE_URL}
      - CMD_OAUTH2_USER_PROFILE_DISPLAY_NAME_ATTR=${CODIMD_OAUTH2_USER_PROFILE_DISPLAY_NAME_ATTR}
      - CMD_OAUTH2_USER_PROFILE_USERNAME_ATTR=${CODIMD_OAUTH2_USER_PROFILE_USERNAME_ATTR}
      - CMD_OAUTH2_USER_PROFILE_EMAIL_ATTR=${CODIMD_OAUTH2_USER_PROFILE_EMAIL_ATTR}
      # Azure Storage
      - CMD_IMAGE_UPLOAD_TYPE=azure
      - CMD_AZURE_CONNECTION_STRING=${CODIMD_AZURE_CONNECTION_STRING}
      - CMD_AZURE_CONTAINER=${CODIMD_AZURE_CONTAINER}
    depends_on:
      - codimd-db
    volumes:
      - ${DATA_ROOT}/codimd/uploads:/home/hackmd/app/public/uploads
    networks:
      - web
      - backend

  # n8n Services
  n8n-db:
    image: postgres:14-alpine
    restart: always
    environment:
      - POSTGRES_USER=${N8N_DB_USER}
      - POSTGRES_PASSWORD=${N8N_DB_PASSWORD}
      - POSTGRES_DB=${N8N_DB_NAME}
    volumes:
      - ${DATA_ROOT}/n8n/db:/var/lib/postgresql/data
    networks:
      - backend

  n8n:
    image: docker.io/n8nio/n8n:latest
    restart: always
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-db
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME}
      - DB_POSTGRESDB_USER=${N8N_DB_USER}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD}
      - N8N_HOST=${N8N_DOMAIN}
      - WEBHOOK_URL=https://${N8N_DOMAIN}
      - NODE_ENV=production
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - GENERIC_TIMEZONE=UTC
      # Secrets from original config
      - THREADS_ACCESS_TOKEN=${N8N_THREADS_ACCESS_TOKEN}
      - EXCHANGE_API_KEY=${N8N_EXCHANGE_API_KEY}
    volumes:
      - ${DATA_ROOT}/n8n/data:/home/node/.n8n
    depends_on:
      - n8n-db
    networks:
      - web
      - backend

networks:
  web:
  backend:
